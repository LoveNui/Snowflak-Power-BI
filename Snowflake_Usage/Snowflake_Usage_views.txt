CREATE OR REPLACE VIEW VW_REP_SNOWFLAKE_STORAGE_USAGE_MONTHLY_SUMMARY
AS
select 
    date_trunc(month, usage_date) as USAGE_MONTH
  , avg(storage_bytes + stage_bytes + failsafe_bytes) / power(1024, 4) as TOTAL_BILLABLE_STORAGE_TB
  , avg(storage_bytes ) / power(1024, 4) as STORAGE_BILLABLE_STORAGE_TB
  , avg(stage_bytes ) / power(1024, 4) as STAGE_BILLABLE_STORAGE_TB
  , avg(failsafe_bytes ) / power(1024, 4) as FAILSAFE_BILLABLE_STORAGE_TB
from SNOWFLAKE.ACCOUNT_USAGE.STORAGE_USAGE
GROUP BY date_trunc(month, usage_date) 
ORDER BY date_trunc(month, usage_date) ;


CREATE OR REPLACE VIEW VW_REP_SNOWFLAKE_WAREHOUSE_METERING_HISTORY
AS
select "START_TIME",
    "END_TIME",
    "WAREHOUSE_ID",
    "WAREHOUSE_NAME",
    "CREDITS_USED",
     TO_DATE(START_TIME) AS START_DATE,
    DATEDIFF(HOUR, START_TIME, END_TIME) AS WAREHOUSE_OPERATION_HOURS,
    TO_TIME(START_TIME) AS TIME_OF_DAY
from "SNOWFLAKE"."ACCOUNT_USAGE"."WAREHOUSE_METERING_HISTORY"
ORDER BY TO_DATE(START_TIME) DESC;

CREATE OR REPLACE VIEW VW_REP_SNOWFLAKE_PIPE_USAGE_HISTORY
AS
select 
  PIPE_ID,
  PIPE_NAME,
  START_TIME,
  END_TIME,
  CREDITS_USED,
  BYTES_INSERTED,
  FILES_INSERTED,
  TO_DATE(START_TIME) AS START_DATE,
  DATEDIFF(HOUR, START_TIME, END_TIME) AS PIPELINE_OPERATION_HOURS,
  HOUR(START_TIME) AS TIME_OF_DAY
from "SNOWFLAKE"."ACCOUNT_USAGE"."PIPE_USAGE_HISTORY"
ORDER BY TO_DATE(START_TIME) DESC;

 CREATE OR REPLACE VIEW VW_REP_DATE_DIMENSION
AS
 -- GENERATES A DAY ROW for 730 days
  WITH CTE_DATE_GENERATOR AS (
    SELECT DATEADD(DAY, SEQ4() * -1, CURRENT_DATE) AS DAY_ROW
      FROM TABLE(GENERATOR(ROWCOUNT=>730))  

  )
  
  
  
  SELECT TO_DATE(DAY_ROW) AS DATE 
        ,YEAR(DAY_ROW) AS YEAR
        ,QUARTER(DAY_ROW) AS QUARTER
        ,MONTH(DAY_ROW) AS MONTH_NUM
        ,MONTHNAME(DAY_ROW) AS MONTH_NAME
        ,WEEKOFYEAR(DAY_ROW) AS WEEK_NUM
        ,DAY(DAY_ROW) AS DAY_NUM
        ,DAYNAME(DAY_ROW) AS DAY_NAME
        ,DAYOFWEEK(DAY_ROW) AS DAY_OF_WEEK
        ,DAYOFYEAR(DAY_ROW) AS DAY_OF_YEAR
    FROM CTE_DATE_GENERATOR
;


